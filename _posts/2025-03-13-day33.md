---
title: "[Day33] ì‡¼í•‘ëª° ì‹¤ìŠµ - ì¥ë°”êµ¬ë‹ˆ, Restful"
categories: [Ureca, Spirng]
tags: [Spirng, REST API, Swagger]
image:
  path: /assets/post/2025/ureca/day33_class_1.png
  alt: spring
published: true
---

## ğŸ“Œ ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ (ë¡œê·¸ì¸ ì¸ì¦ì´ í•„ìš”í•œ ê¸°ëŠ¥)

### 1. DB í…Œì´ë¸” ìƒì„±
```sql
CREATE TABLE cart (
  email VARCHAR(50),
  prodcode INT,
  quantity INT,
  PRIMARY KEY (email, prodcode)
);
```
- ê°™ì€ ì‚¬ìš©ìê°€ ë™ì¼í•œ ìƒí’ˆì„ ì—¬ëŸ¬ ë²ˆ ë‹´ì„ ê²½ìš°, ìˆ˜ëŸ‰ì´ ì¦ê°€

### 2. Cart.java (DTO)
```java
package com.shop.cafe.dto;

public class Cart {
	private String email;
	private int prodcode, quantity;
	public String getEmail() {
		return email;
	}

    public Cart(String email, int prodcode, int quantity) {
        this.email = email;
        this.prodcode = prodcode;
        this.quantity = quantity;
    }

	public Cart() {
		super();
	}
    // Getter & Setter & toString() ìƒëµ
}
```

### 3. CartnDao.java (MyBatis)
ğŸ‘‰ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ê¸°ëŠ¥ì„ DBì— ì—°ê²°.

```java
@Mapper
public interface CartDao {
    void addToCart(Cart cart) throws Exception;
}
```

### 4. CartService.java (Service Layer)
ğŸ‘‰ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ê¸°ëŠ¥ì„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì—°ê²°.
```java
@Service
public class CartService {
    @Autowired
    CartDao cartDao;

    public void addToCart(Cart cart) throws Exception {
        cartDao.addToCart(cart);
    }
}
``` 

---

### 5. CartController.js (API ì—”ë“œí¬ì¸íŠ¸ + ì¸ì¦ ê²€ì‚¬ í¬í•¨)
ğŸ‘‰ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë§Œ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ê°€ëŠ¥ 

- JWT í† í°ì„ ì´ìš©í•œ ë¡œê·¸ì¸ ì¸ì¦ (authorization í—¤ë” í™œìš©)
- 30ë¶„ ì´ë‚´ í™œë™í•œ ê²½ìš°ì—ë§Œ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í—ˆìš©

```java
@RestController
@CrossOrigin("http://127.0.0.1:5500/")
public class CartController {

    @Autowired
    MemberService memberService;
    
    @Autowired
    CartService cartService;
    
    @PostMapping("addToCart")
    public String addToCart(@RequestHeader String authorization, @RequestBody Cart cart) {
        try {
            Login loginInfo = memberService.checkToken(authorization);
            
            if (loginInfo != null && loginInfo.getLoginTime() != null) {
                long now = System.currentTimeMillis(); // í˜„ì¬ ì‹œê°„ (ë°€ë¦¬ì´ˆ) 
                long lastRequestTime = loginInfo.getLoginTime().getTime(); // DBì—ì„œ ê°€ì ¸ì˜¨ ë¡œê·¸ì¸ ì‹œê°„	 
                long interval = now - lastRequestTime; 

                if (interval <= 1800000) { // 30ë¶„ ì´ë‚´ ë¡œê·¸ì¸ ìœ ì§€
                    cart.setEmail(loginInfo.getEmail());
                    cart.setQuantity(1);
                    cartService.addToCart(cart);
                    return "ok";
                }
            }
            return null;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
}
```

---

### 6. cart.xml (MyBatis ì„¤ì •)
- `ON DUPLICATE KEY UPDATE`:  
  **ê°™ì€ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•˜ë©´ ìˆ˜ëŸ‰ ì¦ê°€**í•˜ë„ë¡ ì²˜ë¦¬.

```xml
<mapper namespace="com.shop.cafe.dao.CartDao">
  <insert id="addToCart" parameterType="com.shop.cafe.dto.Cart">
    INSERT INTO cart (email, prodcode, quantity)
    VALUES (#{email}, #{prodcode}, #{quantity})
    ON DUPLICATE KEY UPDATE quantity = quantity + VALUES(quantity);
  </insert>  
</mapper>
```

---

### 7. ë¡œê·¸ì¸ ì¸ì¦ -> MemberService.java
- ë¡œê·¸ì¸ ì‹œ í† í°ì„ ë°œê¸‰í•˜ê³  DBì— ì €ì¥.
- ë¡œê·¸ì¸ ì‹œê°„ë„ ì €ì¥í•˜ì—¬ ì„¸ì…˜ ìœ ì§€ ì‹œê°„(30ë¶„) ì ìš©

```java
@Service
public class MemberService {
    @Autowired
    MemberDao memberDao;

    @Autowired
    LoginDao loginDao;

    public Login checkToken(String authorization) throws Exception {
        return loginDao.checkToken(authorization);
    }

    public Login tokenLogin(Member m) throws Exception {
        m = memberDao.login(m);
        if (m != null) {
            String nickname = m.getNickname();
            if (nickname != null && !nickname.trim().equals("")) {
                String email = m.getEmail();
                String salt = UUID.randomUUID().toString();
                byte[] originalHash = OpenCrypt.getSHA256(email, salt);
                String myToken = OpenCrypt.byteArrayToHex(originalHash);

                Login loginInfo = new Login(email, myToken, nickname, new Date());
                loginDao.insertToken(loginInfo);
                return loginInfo;
            }
        }
        return null;    
    }
}
```

---

### 8. LoginDao.java (ë¡œê·¸ì¸ ì¸ì¦)
- í† í°ì„ ì €ì¥, ì‚­ì œ, ê²€ì¦í•˜ëŠ” ì—­í• .

```java
@Mapper
public interface LoginDao {    
    void insertToken(Login login) throws Exception;
    void deleteToken(String token) throws Exception;
    Login checkToken(String authorization) throws Exception;
}
```

### 9. login.xml  (ë¡œê·¸ì¸ ì¸ì¦)
- ë¡œê·¸ì¸ ì‹œ í† í°ì„ DBì— ì €ì¥
- ë¡œê·¸ì¸ ì‹œê°„ì´ ìë™ìœ¼ë¡œ `NOW()`ë¡œ ê¸°ë¡ë¨.

```xml
<mapper namespace="com.shop.cafe.dao.LoginDao">

  <select id="checkToken" parameterType="String" resultType="Login">
    SELECT * FROM login WHERE token=#{token}
  </select>
  
  <insert id="insertToken" parameterType="Login">
    INSERT INTO login(email, token, loginTime) VALUES(#{email}, #{token}, NOW())
  </insert>
  
  <delete id="deleteToken" parameterType="String">
    DELETE FROM login WHERE token=#{token}
  </delete>
  
</mapper>
```

### 10. secu.propertiesì—ì„œ ì„¸ê³„í‘œì¤€ ì‹œë¥¼ ì œê±°
```
DB_DRIVER=com.mysql.cj.jdbc.Driver
DB_URL=jdbc:mysql://localhost:3306/ureca
DB_USER=ureca
DB_PW=ureca
```

### 11. MemberService.javaì—ì„œ tokenLoginì‹œì— ë¡œê·¸ì¸ ì‹œê°„ì„ ì§ì ‘ ì…ë ¥
```java
public Login tokenLogin(Member m) throws Exception {
    m=memberDao.login(m);
    if(m!=null) {
        String nickname=m.getNickname();
        if(nickname!=null && !nickname.trim().equals("")) {
            String email=m.getEmail();
            String salt=UUID.randomUUID().toString();
            System.out.println("salt:"+salt);
            byte[] originalHash=OpenCrypt.getSHA256(email, salt);
            String myToken=OpenCrypt.byteArrayToHex(originalHash);
            System.out.println("myToken : "+myToken);
            
            // ë¡œê·¸ì¸ ì‹œê°„ì„ ì§ì ‘ ì…ë ¥
            Login loginInfo=new Login(email, myToken, nickname, new Date());
            loginDao.insertToken(loginInfo);
            return loginInfo;
        }
    }
    return null;		 
}
```

---

### cart.js - í”„ë¡ íŠ¸ì—”ë“œ ìš”ì²­
- `localStorage.getItem("token")`: ì €ì¥ëœ ë¡œê·¸ì¸ í† í°ì„ ê°€ì ¸ì™€ `Authorization` í—¤ë”ì— í¬í•¨.
- ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ìš”ì²­ì„ ë³´ëƒ„.

```js
async function addToCart(prodcode) {
    const cartResponse = await axios.post(
        "http://localhost:8080/addToCart",
        { prodcode },
        { headers: { Authorization: localStorage.getItem("token") } } // í† í° í¬í•¨
    );
    console.log(cartResponse.data);
}
```

### ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í´ë¦­ ì‹œ, í…Œì´ë¸” ëª¨ìŠµ

<img src="/assets/post/2025/ureca/day33_class_2.png" alt='' width=1300px>

---

# ğŸ“Œ RESTful API ë€?
RESTfulì— ëŒ€í•œ ê°œë…ì´ ë§ì•„ ë”°ë¡œ í¬ìŠ¤íŒ…í•´ë³´ì•˜ë‹¤.
[RESTful APIë€? ](https://yeeun426.github.io/posts/Restful)

### âœ… RESTful API ë””ìì¸ ê°€ì´ë“œ
> **API URIëŠ” ì§ê´€ì ì´ê³  ì¼ê´€ì„± ìˆê²Œ ì„¤ê³„í•´ì•¼ í•¨**
<img src="/assets/post/2025/ureca/day33_class_3.png" alt='' width=1300px>
<img src="/assets/post/2025/ureca/day33_class_4.png" alt='' width=1300px>
<img src="/assets/post/2025/ureca/day33_class_5.png" alt='' width=1300px>
<img src="/assets/post/2025/ureca/day33_class_6.png" alt='' width=1300px>

### âœ… URI Naming Sample

| HTTP Method | URI ì˜ˆì‹œ | ì„¤ëª… |
|------------|---------------|--------------|
| `GET` | `/products` | ì „ì²´ ìƒí’ˆ ì¡°íšŒ |
| `GET` | `/products/{id}` | íŠ¹ì • ìƒí’ˆ ì¡°íšŒ |
| `POST` | `/cart` | ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ì¶”ê°€ |
| `PUT` | `/cart/{id}` | ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ìˆ˜ì • |
| `DELETE` | `/cart/{id}` | ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ì‚­ì œ |

---

### âœ… RESTful API Controller ì˜ˆì œ

```java
@RestController
@CrossOrigin("http://127.0.0.1:5500/")
@RequestMapping("/api/members") // ê¸°ë³¸ URIë¥¼ ì„¤ì •
public class RestMemberController {
    
    @Autowired
    MemberService memberService;    

    @DeleteMapping("/{id}") // íšŒì› ì‚­ì œ
    public String deleteMember(@PathVariable Long id) {
        System.out.println("Deleting member with ID: " + id);
        try {
            memberService.deleteMemberById(id);
            return "ok";
        } catch (Exception e) {
            e.printStackTrace();
            return "íšŒì› ì‚­ì œ ì‹¤íŒ¨";
        }
    }
}
```

---

# ğŸ“Œ Swagger ì‚¬ìš©í•˜ê¸°
## 1. `pom.xml` ì˜ì¡´ì„± ì¶”ê°€**
```xml
<dependency>
    <groupId>org.springdoc</groupId>
    <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
    <version>2.2.0</version>
</dependency>
```

## 2. Swagger UI ì ‘ì†
Swagger UIë¥¼ í†µí•´ API ë¬¸ì„œ ìë™ ìƒì„± ë° í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

```
http://localhost:8080/swagger-ui/index.html
```

<img src="/assets/post/2025/ureca/day33_class_1.png" alt='' width=1300px>

---

## END