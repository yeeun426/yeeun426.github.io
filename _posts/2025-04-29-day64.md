---
title: "[Day62] TanStack Query(React Query)"
categories: [Ureca, React]
tags: [React, JS, Tab, React Query, TanStack]
image:
  path: /assets/post/2025/ureca/day64_class_7.png
  alt: React
published: true
---

# TanStack Query ë€?

> **ì„œë²„ ìƒíƒœ(Server State)** ê´€ë¦¬ë¥¼ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬         
> ì„œë²„ë¡œë¶€í„° ë°ì´í„°ë¥¼ **ê°€ì ¸ì˜¤ê¸°(fetch), ìºì‹±(cache), ìë™ ê°±ì‹ (refetch)** ë“±ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤

## ì£¼ìš” ê¸°ëŠ¥
- ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ìºì‹±
- ë™ì¼ ìš”ì²­ì˜ ì¤‘ë³µ ì œê±°
- ë¬´í•œ ìŠ¤í¬ë¡¤, í˜ì´ì§€ë„¤ì´ì…˜ ë“±ì˜ ì„±ëŠ¥ ìµœì í™”
- ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²°, ìš”ì²­ ì‹¤íŒ¨ ë“±ì˜ ìë™ ê°±ì‹ 

## ë°ì´í„° ìºì‹±

- ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” í•­ìƒ ì¿¼ë¦¬ í‚¤(queryKey)ë¥¼ ì§€ì •í•˜ê²Œ ë¨
- ì´ queryKeyëŠ” ìºì‹œëœ ë°ì´í„°ì™€ ë¹„êµí•´ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ì§€, ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í• ì§€ ê²°ì •í•˜ëŠ” ê¸°ì¤€ì´ ëœë‹¤.

```js
useQuery({
  queryKey: ['delay'],
  queryFn: () => fetch('...').then(res => res.json())
})
```

- `queryKey`: ë°ì´í„°ë¥¼ êµ¬ë¶„í•˜ëŠ” ê³ ìœ í•œ ì´ë¦„
- ê°™ì€ `queryKey`ë¡œ ìš”ì²­í•˜ë©´ ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©


### ë™ì‘ ì›ë¦¬

1. queryKeyì— í•´ë‹¹í•˜ëŠ” ìºì‹œê°€ ì—†ìœ¼ë©´ â†’ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
2. ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë©´ ê·¸ ë°ì´í„°ëŠ” ìºì‹œë˜ê³  ê·¸ ì´í›„ ìš”ì²­ë¶€í„°ëŠ” ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
<img src="/assets/post/2025/ureca/day64_class_7.png" alt='' width=1300px>

1. queryKeyì— í•´ë‹¹í•˜ëŠ” ìºì‹œê°€ ìˆìœ¼ë©´ â†’ ì„œë²„ì— ìš”ì²­í•˜ì§€ ì•Šê³  ìºì‹œ ë°ì´í„° ì‚¬ìš©
2. ë”°ë¼ì„œ ê°™ì€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìš”ì²­ì´ ì—¬ëŸ¬ ë²ˆ ë°œìƒí•´ë„, ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ì–´ ì¤‘ë³µ ìš”ì²­ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.
<img src="/assets/post/2025/ureca/day64_class_8.png" alt='' width=1300px>

ê·¸ë ‡ë‹¤ë©´ í•œë²ˆ ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´, ì„œë²„ë¡œëŠ” ë” ì´ìƒ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ëŠ” ê±¸ê¹Œ? -> ë°ì´í„°ì˜ ì‹ ì„ ë„

## ë°ì´í„°ì˜ ì‹ ì„ ë„
 TanStack QueryëŠ” ìºì‹œí•œ ë°ì´í„°ë¥¼ ì‹ ì„ (Fresh)í•˜ê±°ë‚˜ ìƒí•œ(Stale) ìƒíƒœë¡œ êµ¬ë¶„í•´ ê´€ë¦¬í•œë‹¤.      
- ìºì‹œëœ ë°ì´í„°ê°€ ì‹ ì„  -> ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©
- ë°ì´í„°ê°€ ìƒí•¨ -> ì„œë²„ì— ë‹¤ì‹œ ìš”ì²­í•´ ì‹ ì„ í•œ(ìƒˆë¡œìš´) ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´

```js
import { useQuery } from '@tanstack/react-query'

export default function DelayedData() {
  const { data, isStale } = useQuery({
    queryKey: ['delay'],
    queryFn: async () => (await fetch('https://api.heropy.dev/v0/delay?t=1000')).json(),
    staleTime: 1000 * 10 // 10ì´ˆ í›„ ìƒí•¨. ì¦‰, 10ì´ˆ ë™ì•ˆ ì‹ ì„ í•¨.
  })
  return (
    <>
      <div>ë°ì´í„°ê°€ {isStale ? 'ìƒí–ˆì–´ìš”..' : 'ì‹ ì„ í•´ìš”!'}</div>
      <div>{JSON.stringify(data)}</div>
    </>
  )
}
```

- `staleTime` : ìºì‹œëœ ë°ì´í„°ê°€ ì‹ ì„ í•œ ìƒíƒœë¡œ ìœ ì§€ë˜ëŠ” ì‹œê°„(ms)
- `isStale` : í˜„ì¬ ë°ì´í„°ê°€ ì‹ ì„ í•œì§€ ì—¬ë¶€

## useQuery

- ê°€ì¥ ê¸°ë³¸ì ì¸ ì¿¼ë¦¬ í›…ìœ¼ë¡œ, ì»´í¬ë„ŒíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©
- ë¡œë”© ìƒíƒœ, ì—ëŸ¬ ì²˜ë¦¬, ìë™ ì¬ìš”ì²­, ìºì‹± ì „ëµê¹Œì§€ ëª¨ë‘ ê´€ë¦¬í•´ì¤€ë‹¤.

### ê¸°ë³¸ êµ¬ì¡°
```js
const query = useQuery<DataType>({
  queryKey: ['key'],
  queryFn: async () => await fetch(...).then(res => res.json()),
  ...ê¸°íƒ€ ì˜µì…˜ë“¤
})
```

### ì£¼ìš” ì˜µì…˜
- `queryKey` : ìºì‹œë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•œ ê³ ìœ  í‚¤ (ë°°ì—´ ê¶Œì¥)
- `queryFn` : ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
- `staleTime` : ë°ì´í„°ê°€ ì‹ ì„ í•˜ê²Œ ìœ ì§€ë˜ëŠ” ì‹œê°„(ms)
- `cacheTime` : ìºì‹œ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ìœ ì§€í•  ì‹œê°„


----


# TanStack Queryë¥¼ í™œìš©í•œ ë‚ ì”¨ API ë¦¬íŒ©í„°ë§
## ğŸ”¸ QueryClient ì„¸íŒ… - main.jsx

```js
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import { RouterProvider } from "react-router-dom";
import { router } from "./router/index";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";

// ì „ì—­ì—ì„œ Queryë¥¼ ê´€ë¦¬í•  QueryClient ìƒì„±
const queryClient = new QueryClient();

// ì•± ì „ì²´ì—ì„œ React Query ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
createRoot(document.getElementById("root")).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
        {/* ê°œë°œ ì¤‘ì—ëŠ” ReactQueryDevtoolsë¡œ ìƒíƒœ í™•ì¸ ê°€ëŠ¥ */}
      {import.meta.env.DEV && <ReactQueryDevtools initialIsOpen={false} />}
    </QueryClientProvider>
  </StrictMode>
);
```

### React Query Devtoolsë¡œ ìƒíƒœ í™•ì¸ ê°€ëŠ¥

<img src="/assets/post/2025/ureca/day64_class_2.png" alt='' width=1300px>


## ğŸ”¸ useWeatherApi.jsx
```js
// ì»¤ìŠ¤í…€ í›…ìœ¼ë¡œ ê³µí†µí™”
export const useWeather = (city) => {
  console.log("ë‚ ì”¨ ë°ì´í„°:", city);
  return useQuery({
    queryKey: ["weather", city], // ìºì‹± ë° ì¬ìš”ì²­ êµ¬ë¶„ ê¸°ì¤€
    queryFn: async () => {
      try {
        const data = city ? await getCountryData(city) : await getCurrentData();
        return data;
      } catch (err) {
        console.log("", err);
      }
    },
    staleTime: 1000 * 60 * 5,
    retry: 1,
  });
};
```

#### â“ `staleTime` ì™œ ì“°ëŠ”ê°€?
- `staleTime` ë™ì•ˆì€ ìºì‹œëœ ë°ì´í„°ë¥¼ **ì‹ ì„ í•œ(fresh)** ë°ì´í„°ë¡œ ê°„ì£¼
- ê°™ì€ ì¿¼ë¦¬ ìš”ì²­ ì‹œ, API ì¬í˜¸ì¶œ ì—†ì´ **ìºì‹œëœ ë°ì´í„°ë§Œ ì‚¬ìš©**
- íŠ¹íˆ ê³µê³µ APIì²˜ëŸ¼ **ìš”ì²­ ì œí•œ**ì´ ìˆëŠ” ê²½ìš° ìœ ìš©  
  ğŸ‘‰ ë‚ ì”¨, ì˜¤ëŠ˜ì˜ ì˜í™” ë“± **ìì£¼ ë°”ë€Œì§€ ì•ŠëŠ” ì •ë³´**ì— ì í•©


### ì½˜ì†” ì¶œë ¥ ì˜ˆì‹œ

```js
const res = useWeather(city);
console.log("res", res.data);
```

- `res`ëŠ” TanStack Queryê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´
    - `res.data`: ë‚ ì”¨ ë°ì´í„°
    - `res.isLoading`: ë¡œë”© ì—¬ë¶€
    - `res.isError`: ì—ëŸ¬ ì—¬ë¶€

#### `console.log(res)`
<img src="/assets/post/2025/ureca/day64_class_3.png" alt='' width=900px>

#### `console.log(res.data)`
<img src="/assets/post/2025/ureca/day64_class_1.png" alt='' width=900px>

- data, isLoading, isError ë“± í•„ìš”í•œ ì •ë³´ê°€ ê°ì²´ë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬ë˜ì–´ ìˆìŒ

## ğŸ”¸ ê¸°ì¡´ ë°©ì‹ (useEffect + fetch)

```js
useEffect(() => {
  const fetchWeatherData = async () => {
    try {
      let data;
      if (city) {
        data = await getCountryData(city);
      } else {
        data = await getCurrentData();
      }
      setWeatherData(data);
    } catch (err) {
      console.err(err);
    }
  };
  fetchWeatherData();
}, [city]);
```

- ì§ì ‘ API í˜¸ì¶œ â†’ ìƒíƒœ ê´€ë¦¬ í•„ìš” (`useState`, `useEffect`)
- ìºì‹±, ì¬ì‹œë„, ë¡œë”©/ì—ëŸ¬ ìƒíƒœ ë”°ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨
- ìš”ì²­ ì‹œë§ˆë‹¤ í•­ìƒ API í˜¸ì¶œë¨ â†’ ë¹„íš¨ìœ¨ì 

## ğŸ”¸ ê°œì„  ë°©ì‹ (TanStack Query ì‚¬ìš©)
```js
const { data: weatherData, isLoading, isError } = useWeather(city);
```

- weatherData: ì‹¤ì œ ë‚ ì”¨ ë°ì´í„°
- isLoading: ë¡œë”© ì¤‘ ì—¬ë¶€
- isError: ì˜¤ë¥˜ ë°œìƒ ì—¬ë¶€
<br/>
ğŸ’¡ ìƒíƒœ ë¶„ê¸°ë§Œ í•´ì£¼ë©´ ê°„í¸í•˜ê²Œ UI ë Œë”ë§ ê°€ëŠ¥

## ğŸ”¸ ë³€ê²½ í¬ì¸íŠ¸

| í•­ëª© | ê¸°ì¡´ ë°©ì‹ | TanStack Query |
|------|------------|----------------|
| ìƒíƒœ ê´€ë¦¬ | ìˆ˜ë™ (useState + useEffect) | ìë™ (`isLoading`, `isError`, `data`) |
| ìºì‹± | X | O (`queryKey` ê¸°ì¤€) |
| ì¬ì‹œë„ | X | O (`retry`) |
| ì˜¤ë˜ëœ ë°ì´í„° | ìˆ˜ë™ ê´€ë¦¬ | `staleTime` ìœ¼ë¡œ ìë™ ê´€ë¦¬ |
| ê°œë°œ í¸ì˜ì„± | ì§ì ‘ í•¸ë“¤ë§ í•„ìš” | í›¨ì”¬ ê°„ê²°í•˜ê³  ì¬ì‚¬ìš©ì„± ë†’ìŒ |

## ğŸ“ ì „ì²´ íë¦„ ìš”ì•½

1. `useWeather(city)` ì»¤ìŠ¤í…€ í›…ìœ¼ë¡œ ê³µí†µ ë¡œì§ ë¶„ë¦¬
2. `queryFn` ë‚´ë¶€ì—ì„œ `city`ì— ë”°ë¼ API í˜¸ì¶œ ê²°ì •
3. `staleTime` ì„¤ì •ìœ¼ë¡œ **ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ìµœì†Œí™”**
4. `QueryClientProvider`ë¡œ ì•± ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
5. ê°œë°œ ì¤‘ì—” `ReactQueryDevtools`ë¡œ ìƒíƒœ ë””ë²„ê¹… ê°€ëŠ¥

## ğŸ”¸ ì‹¤ìŠµ UI

<img src="/assets/post/2025/ureca/day64_class_4.png" alt='' width=1300px>

---------------

# ìº í•‘ì¥ API - TanStack Query ì ìš© íë¦„
## ğŸ”¸ ìº í•‘ì¥ ë°ì´í„° API í˜¸ì¶œ - `getCamping.js`
```js
import axios from "axios";

const CAMPING_API = import.meta.env.VITE_CAMPING_API_KEY;
const CAMPING_BASE_URL =
  "https://api.odcloud.kr/api/15037499/v1/uddi:adf7c061-042d-4965-9b7c-87585251862b";

export const getCampingData = async (page = 1, perPage = 10) => {
  try {
    const res = await axios.get(
      `${CAMPING_BASE_URL}?page=${page}&perPage=${perPage}&serviceKey=${CAMPING_API}`
    );
    return res.data;
  } catch (error) {
    console.log(err);
  }
};
```

## ğŸ”¸ ìº í•‘ì¥ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” í›… - `useCamping.js`
```js
import { useQuery } from "@tanstack/react-query";
import { getCampingData } from "./getCampingApi";

export const useCamping = (page, perPage) => {
  return useQuery({
    queryKey: ["camping", page], // í˜ì´ì§€ ë³„ë¡œ ìºì‹±
    queryFn: async () => await getCampingData(page, perPage),
    staleTime: 1000 * 60 * 5, // 5ë¶„ ë™ì•ˆì€ ìƒˆë¡œìš´ ìš”ì²­ ì—†ì´ ìºì‹œ ì‚¬ìš©
    cacheTime: 1000 * 60 * 10, // ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ 10ë¶„ë™ì•ˆ ë©”ëª¨ë¦¬ì— ìœ ì§€
  });
};
```

- `staleTime` : ë°ì´í„°ê°€ ì‹ ì„ í•˜ë‹¤ê³  ê°„ì£¼ë˜ëŠ” ì‹œê°„. ì´ ì‹œê°„ ë™ì•ˆì€ ì¬ìš”ì²­ ì—†ì´ ìºì‹œ ì‚¬ìš©
- `cacheTime` : ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ëœ í›„ì—ë„ ë°ì´í„°ë¥¼ ìºì‹œì— ìœ ì§€í•˜ëŠ” ì‹œê°„

## ğŸ”¸ ì»´í¬ë„ŒíŠ¸ - CampingPage.jsx

```js
import React, { useState } from "react";
import { useCamping } from "./useCamping";
import css from "./CampingPage.module.css";
import DetailModal from "./DetailModal";

const CampingPage = () => {
  // TanStack Queryë¥¼ í†µí•´ ìº í•‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const { data, isError, isLoading } = useCamping(1, 10);
  // ìº í•‘ ë°ì´í„° êµ¬ì¡° ë¶„í•´
  const campingData = data?.data;
  const totalCount = data?.totalCount;
  const page = data?.page;
  const perPage = data?.perPage;
  // ìƒíƒœ ì²˜ë¦¬
  isError && <p>ì—ëŸ¬ ë°œìƒ</p>;
  isLoading && <p>Loading..</p>;

  return (
    <main>
        <p>
          ì´ {totalCount}ê°œ ì¤‘ {perPage}ê°œ í‘œì‹œ / í˜„ì¬ {page}page
        </p>
        <ul className={css.list}>
          {campingData?.map((list, i) => (
            <li
              key={list["ì•¼ì˜ì¥ëª…"] + i}
              onClick={() => handleCampingClick(list)}
            >
              <p>ì•¼ì˜ì¥ëª… : {list["ì•¼ì˜ì¥ëª…"]}</p>
              <p>ì£¼ì†Œ : {list["ì£¼ì†Œ"]}</p>
              <p>
                ì—°ë½ì²˜ : {list["ì—°ë½ì²˜ ì•ìë¦¬"]}-{list["ì—°ë½ì²˜ ì¤‘ê°„ìë¦¬"]}-
                {list["ì—°ë½ì²˜ ëìë¦¬"]}
              </p>
            </li>
          ))}
        </ul>
    </main>
  );
};

export default CampingPage;
```

## ğŸ”¸ ì‹¤ìŠµ UI

<img src="/assets/post/2025/ureca/day64_class_5.png" alt='' width=1300px>

<img src="/assets/post/2025/ureca/day64_class_6.png" alt='' width=1300px>

------

[github ì½”ë“œ ì°¸ê³ ](https://github.com/yeeun426/React-study/tree/main/react05_apis)


-----

## Reference

- [TanStack Query(React Query) í•µì‹¬ ì •ë¦¬](https://www.heropy.dev/p/HZaKIE)

----

## END