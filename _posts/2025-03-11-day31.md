---
title: "[Day31] ì‡¼í•‘ëª° ì‹¤ìŠµ - í† í°"
categories: [Ureca, Spirng]
tags: [Spirng, token]
image:
  path: /assets/post/2025/ureca/spring_security.png
  alt: spring
published: true
---

# JSESSIONIDê°€ ìš”ì²­ ì‹œ ìë™ìœ¼ë¡œ í¬í•¨ë˜ì§€ ì•ŠëŠ” ë¬¸ì œì™€ í•´ê²° ë°©ë²•
í”„ë¡ íŠ¸ì—”ë“œ (:5500)ì—ì„œ ë°±ì—”ë“œ (:8080)ë¡œ ë¡œê·¸ì¸ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ JSESSIONIDë¥¼ ë°›ì•„ ì €ì¥í–ˆì§€ë§Œ, ì´í›„ ìš”ì²­ì—ì„œ ì¿ í‚¤ê°€ ìë™ìœ¼ë¡œ í¬í•¨ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ ë°œìƒ.

## ë°©ì•ˆ 1. êµ¬ì¡° ë³€ê²½
- í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë°±ì—”ë“œ ì„œë²„ì—ì„œ ì„œë¹™í•˜ì—¬ ë™ì¼í•œ ë„ë©”ì¸/í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½.

## ë°©ì•ˆ 2. ì¿ í‚¤ ì„¤ì • ë³€ê²½ (í† í°)

### ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„±
```sql
use ureca;

CREATE TABLE `ureca`.`login` (
  `email` VARCHAR(50) NOT NULL primary key,
  `token` VARCHAR(256) NOT NULL unique,
  `logintime` TIMESTAMP NOT NULL DEFAULT current_timestamp
);
```

### OpenCrypt.java (ì•”í˜¸í™” ìœ í‹¸ë¦¬í‹°)
- SHA-256ì„ ì´ìš©í•´ ì´ë©”ì¼ì„ í•´ì‹±í•˜ì—¬ í† í°ì„ ìƒì„±.
- AES-256 ì•”í˜¸í™”ë¥¼ ì§€ì›.

```java
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import javax.crypto.Cipher;
import javax.crypto.KeyGenerator;
import javax.crypto.SecretKey;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;

public class OpenCrypt {

    public static byte[] getSHA256(String source, String salt) {
        byte byteData[]=null;
        try{
            MessageDigest md = MessageDigest.getInstance("SHA-256"); 
            md.update(source.getBytes()); 
            md.update(salt.getBytes()); 
            byteData= md.digest();  
            System.out.println("ì›ë¬¸: "+source+ "   SHA-256: "+
                                    byteData.length+","+byteArrayToHex(byteData));
        }catch(NoSuchAlgorithmException e){
            e.printStackTrace(); 
        }
        return byteData;
    }
	 	 
    public static byte[] generateKey(String algorithm,int keySize) throws NoSuchAlgorithmException {    
        KeyGenerator keyGenerator = KeyGenerator.getInstance(algorithm);	 
        keyGenerator.init(keySize);
        SecretKey key = keyGenerator.generateKey();
        return key.getEncoded();	 
    }	

    public static String aesEncrypt(String msg, byte[] key) throws Exception {
        SecretKeySpec skeySpec = new SecretKeySpec(key, "AES");
            Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
            String iv = "AAAAAAAAAAAAAAAA";
            cipher.init(Cipher.ENCRYPT_MODE, 
                        skeySpec,
                        new IvParameterSpec(iv.getBytes()));        
            byte[] encrypted = cipher.doFinal(msg.getBytes());     
            return  byteArrayToHex(encrypted);
    }
	 
    public static String aesDecrypt(String msg,byte[] key ) throws Exception {
        SecretKeySpec skeySpec = new SecretKeySpec(key, "AES");
        Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
        String iv = "AAAAAAAAAAAAAAAA";
        cipher.init(Cipher.DECRYPT_MODE, 
                    skeySpec,
                    new IvParameterSpec(iv.getBytes()));  
        byte[] encrypted = hexToByteArray(msg);
        byte[] original = cipher.doFinal(encrypted);  
        return new String(original); 
    }
	 
    public static byte[] hexToByteArray(String hex) {
        if (hex == null || hex.length() == 0) {
            return null;
        }
        
        byte[] ba = new byte[hex.length() / 2];
        for (int i = 0; i < ba.length; i++) {
            ba[i] = (byte) Integer.parseInt(hex.substring(2 * i, 2 * i + 2), 16);
        }
        return ba;
    }
		 
    // byte[] to hex
    public static String byteArrayToHex(byte[] ba) {
        if (ba == null || ba.length == 0) {
            return null;
        }
        
        StringBuffer sb = new StringBuffer(ba.length * 2);
        String hexNumber;
        for (int x = 0; x < ba.length; x++) {
            hexNumber = "0" + Integer.toHexString(0xff & ba[x]);
        
            sb.append(hexNumber.substring(hexNumber.length() - 2));
        }
        return sb.toString();
    } 	 
}
```

### MemberService.java (í† í° ë¡œê·¸ì¸ ë¡œì§)
1. ì‚¬ìš©ì ì¸ì¦ í›„ ì´ë©”ì¼ì„ ê¸°ë°˜ìœ¼ë¡œ í† í° ìƒì„±
2. í† í°ì„ login í…Œì´ë¸”ì— ì €ì¥
3. í† í°ì„ ì‘ë‹µí•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì €ì¥ í›„ ì‚¬ìš©í•˜ë„ë¡ ì²˜ë¦¬

```java
package com.shop.cafe.service;

import java.util.UUID;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.shop.cafe.dao.LoginDao;
import com.shop.cafe.dao.MemberDao;
import com.shop.cafe.dto.Login;
import com.shop.cafe.dto.Member;
import com.shop.cafe.util.OpenCrypt;

@Service
public class MemberService {
	@Autowired
	MemberDao memberDao;
	
	@Autowired
	LoginDao loginDao;

	public Login tokenLogin(Member m) throws Exception {
		m=memberDao.login(m);
		if(m!=null) {
			String nickname=m.getNickname();
			if(nickname!=null && !nickname.trim().equals("")) {
				//member tableì—ì„œ emailê³¼ pwdê°€ í™•ì¸ëœ ìƒí™© ì¦‰ login ok
				String email=m.getEmail();
				//1. saltë¥¼ ìƒì„±í•œë‹¤
				String salt=UUID.randomUUID().toString();
				System.out.println("salt:"+salt);
				//2. emailì„ hashing í•œë‹¤
				byte[] originalHash=OpenCrypt.getSHA256(email, salt);
				//3. dbì— ì €ì¥í•˜ê¸° ì¢‹ì€ í¬ë§·ìœ¼ë¡œ ì¸ì½”ë”©í•œë‹¤
				String myToken=OpenCrypt.byteArrayToHex(originalHash);
				System.out.println("myToken : "+myToken);
				
				//4. login tableì— token ì €ì¥
				Login loginInfo=new Login(email, myToken, nickname, null);
				loginDao.insertToken(loginInfo);
				return loginInfo;
			}
		}
		return null;		 
	}
	
	public Member login(Member m) throws Exception {
		return memberDao.login(m);
	}
	
	public void insertMember(Member m) throws Exception{
		memberDao.insertMember(m);
	}
	
	public void updateMember(Member m) throws Exception{
		memberDao.updateMember(m);
	}
	
	public void deleteMember(String email) throws Exception{
		memberDao.deleteMember(email);
	}

	public void logout(String authorization) throws Exception {
		loginDao.deleteToken(authorization);	
	}
}
```

### Login.java (DTO)
- ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” DTO

```java
package com.shop.cafe.dto;

import java.util.Date;

public class Login {
	private String email, token, nickname;
	private Date loginTime;
	
	public Login(String email, String token, String nickname, Date loginTime) {
		super();
		this.email = email;
		this.token = token;
		this.nickname = nickname;
		this.loginTime = loginTime;
	}

	public Login() {
		super();
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}

	public String getToken() {
		return token;
	}

	public void setToken(String token) {
		this.token = token;
	}

	public String getNickname() {
		return nickname;
	}

	public void setNickname(String nickname) {
		this.nickname = nickname;
	}

	public Date getLoginTime() {
		return loginTime;
	}

	public void setLoginTime(Date loginTime) {
		this.loginTime = loginTime;
	}

	@Override
	public String toString() {
		return "Login [email=" + email + ", token=" + token + ", nickname=" + nickname + ", loginTime=" + loginTime
				+ "]";
	}
}
```

### LoginDao.java (í† í° ì €ì¥/ì‚­ì œ)
- í† í°ì„ DBì— ì €ì¥í•˜ê³  ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µ.

```java
package com.shop.cafe.dao;
import org.apache.ibatis.annotations.Mapper;
import com.shop.cafe.dto.Login;

@Mapper
public interface LoginDao {	
	public void insertToken(Login login) throws Exception;

	public void deleteToken(String token) throws Exception;
}
```

### login.xml (MyBatis ì„¤ì •)**
- `insertToken`: ë¡œê·¸ì¸ ì‹œ í† í°ì„ ì €ì¥.
- `deleteToken`: ë¡œê·¸ì•„ì›ƒ ì‹œ í† í° ì‚­ì œ.

```xml
<mapper namespace="com.shop.cafe.dao.LoginDao">
    <insert id="insertToken" parameterType="Login">
        insert into login(email, token) values(#{email},#{token})
    </insert>
    
    <delete id="deleteToken" parameterType="String">
        delete from login where token=#{token}
    </delete>
</mapper>
```

### MemberController.java (API ì—”ë“œí¬ì¸íŠ¸)
- ë¡œê·¸ì¸ ì‹œ í† í°ì„ ìƒì„±í•˜ì—¬ ì‘ë‹µ
- ì´í›„ ìš”ì²­ì€ `Authorization` í—¤ë”ì— í† í°ì„ ë‹´ì•„ ì¸ì¦

```java
@CrossOrigin("http://127.0.0.1:5500/")
@RestController
public class MemberController {
    
    @PostMapping("tokenLogin")
    public Map<String, String> tokenLogin(@RequestBody Member m) {
        Map<String, String> responseMap = new HashMap<>();
        try {
            Login loginInfo = memberService.tokenLogin(m);
            if (loginInfo != null) {
                responseMap.put("nickname", loginInfo.getNickname());
                responseMap.put("Authorization", loginInfo.getToken());
            } else {
                responseMap.put("msg", "ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”");
            }
        } catch (Exception e) {
            responseMap.put("msg", "ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”");
        }
        return responseMap;
    }

    @PostMapping("logout")
    public void logout(@RequestHeader String authorization) {
        try {
            memberService.logout(authorization);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### í”„ë¡ íŠ¸ì—”ë“œ axios ì„¤ì • ë³€ê²½
ë°±ì—”ë“œê°€ ì¿ í‚¤ë¥¼ ìœ ì§€í•˜ë„ë¡ í—ˆìš©í–ˆë‹¤ë©´, í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ìš”ì²­ ì‹œ withCredentials: true ì˜µì…˜ì„ ì¶”ê°€í•´ì•¼ í•¨.

```js
document.getElementById("loginBtn").addEventListener("click", async () => {  
  const email = document.getElementById("loginEmail").value;
  const pwd = document.getElementById("loginPwd").value;
  const data = {  email, pwd };
  const response=await axios.post("http://localhost:8080/tokenLogin" , data);
  
  document.getElementById("loginSpan").innerHTML=`${response.data.nickname}  
  <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>`;
  const token = response.data.Authorization;

  sessionStorage.setItem('Authorization', token);
  sessionStorage.setItem('nickname', response.data.nickname);
  axios.defaults.headers.common['Authorization'] = token; // Authorization í—¤ë” ì„¤ì •

  const modal = bootstrap.Modal.getInstance(document.getElementById("loginModal"));
  loginModal.setAttribute("aria-hidden", "true");
  modal.hide();
});

const Authorization = sessionStorage.getItem("Authorization");
const nickname = sessionStorage.getItem("nickname");
if (Authorization && nickname) {
  axios.defaults.headers.common['Authorization'] = Authorization; // Authorization í—¤ë” ì„¤ì •
  document.getElementById("loginSpan").innerHTML = `${nickname}  
  <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>`;
}

document.getElementById("loginSpan").addEventListener("click", async (event)=>{
  if(event.target.id=='logoutBtn'){       
      await axios.post("http://localhost:8080/logout");
      sessionStorage.removeItem("nickname");
      sessionStorage.removeItem("Authorization");
      axios.defaults.headers.common['Authorization'] = ''; // Authorization í—¤ë”ì—ì„œ ì‚­ì œ       
      window.location.reload();
  }
});
```

## ê²°ê³¼
- JSESSIONID ëŒ€ì‹  í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„ ê´€ë¦¬
- í´ë¼ì´ì–¸íŠ¸ëŠ” ì‘ë‹µë°›ì€ `Authorization` í† í°ì„ ì´í›„ ìš”ì²­ì˜ í—¤ë”ì— í¬í•¨í•˜ì—¬ ì¸ì¦ì„ ìˆ˜í–‰.
- DBì— ì €ì¥ëœ í† í°ì„ í™œìš©í•´ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŒ.

<img src="/assets/post/2025/ureca/day31_class_3.png" alt='' width=1300px>
<img src="/assets/post/2025/ureca/day31_class_2.png" alt='' width=1300px>

---

## `Request Header`ì™€ `Request Body`ì˜ ì°¨ì´  
### 1ï¸âƒ£ Request Header (ìš”ì²­ í—¤ë”)
- ìš”ì²­ì— ëŒ€í•œ **ë©”íƒ€ë°ì´í„°**(ë¶€ê°€ ì •ë³´)ë¥¼ í¬í•¨
- ìš”ì²­ì˜ í˜•ì‹, ì¸ì¦ ì •ë³´, ìºì‹± ì •ì±…, í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ë“±ì„ ì „ë‹¬
- ì£¼ë¡œ í‚¤-ê°’ ìŒ (Key-Value Pair) í˜•íƒœë¡œ í‘œí˜„ë¨

```http
POST /api/user HTTP/1.1
Host: example.com
Content-Type: application/json
Authorization: Bearer token123
```

- `Content-Type`: ìš”ì²­ ë³¸ë¬¸ì˜ ë°ì´í„° í˜•ì‹ì„ ì§€ì • (ì˜ˆ: `application/json`)
- `Authorization`: ì¸ì¦ ì •ë³´ë¥¼ ì „ë‹¬ (ì˜ˆ: JWT í† í°)
- `User-Agent`: í´ë¼ì´ì–¸íŠ¸(ë¸Œë¼ìš°ì € ë˜ëŠ” ì•±)ì˜ ì •ë³´  

---

### 2ï¸âƒ£ Request Body (ìš”ì²­ ë³¸ë¬¸)
- ìš”ì²­ì˜ **ì‹¤ì œ ë°ì´í„°(payload)** ë¥¼ í¬í•¨
- `POST`, `PUT`, `PATCH` ë“±ì˜ ìš”ì²­ì—ì„œ ì£¼ë¡œ ì‚¬ìš©
- `GET` ìš”ì²­ì—ëŠ” ë³´í†µ ë³¸ë¬¸ì´ ì—†ìŒ

```json
{
    "username": "yeeun",
    "password": "secure123"
}
```

- ìš”ì²­ì˜ ë³¸ë¬¸ì—ëŠ” ì‹¤ì œ ë°ì´í„°ë¥¼ ë‹´ì•„ ì„œë²„ë¡œ ì „ë‹¬í•¨
- `Content-Type: application/json` í—¤ë”ê°€ ìˆì–´ì•¼ JSON ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŒ


### ì •ë¦¬

| êµ¬ë¶„ | Request Header | Request Body |
|------|--------------|--------------|
| ì—­í•  | ìš”ì²­ì˜ ë©”íƒ€ë°ì´í„° | ìš”ì²­ì˜ ì‹¤ì œ ë°ì´í„° |
| í¬í•¨ ì •ë³´ | ì¸ì¦ ì •ë³´, ì½˜í…ì¸  íƒ€ì…, ì¿ í‚¤ ë“± | ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°, íŒŒì¼ ë“± |
| í˜•ì‹ | í‚¤-ê°’ ìŒ (Key-Value) | JSON, XML, FormData ë“± |

---

# Teamwork Challenge - ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
## ë°±ì—”ë“œ (BACK)
### ë°ì´í„°ë² ì´ìŠ¤ (MySQL) : cart í…Œì´ë¸” ìƒì„±
```sql
create table cart(
cartNo int primary key,
token varchar(256) not null,
prodcode int not null,
);
```

### ë°ì´í„° ëª¨ë¸(DTO) : Cart.java
- member í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” ê°ì²´
- íšŒì› ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í•„ë“œ ë° getter, setter í¬í•¨

```java
package com.shop.cafe.dto;

public class Cart {
	private int cartNo,prodcode;
	private String token;
	public Cart(int cartNo, int prodcode, String token) {
		super();
		this.cartNo = cartNo;
		this.prodcode = prodcode;
		this.token = token;
	}
	public Cart() {
		super();
		// TODO Auto-generated constructor stub
	}
	public int getCartNo() {
		return cartNo;
	}
	public void setCartNo(int cartNo) {
		this.cartNo = cartNo;
	}
	public int getProdcode() {
		return prodcode;
	}
	public void setProdcode(int prodcode) {
		this.prodcode = prodcode;
	}
	public String getToken() {
		return token;
	}
	public void setToken(String token) {
		this.token = token;
	}
	@Override
	public String toString() {
		return "Cart [cartNo=" + cartNo + ", prodcode=" + prodcode + ", token=" + token + "]";
	}	
}
```

### ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ(DAO) : CartDao.java
ğŸ”¹ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í•˜ì—¬ íšŒì› ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì—­í• 

```java
package com.shop.cafe.dao;

import java.util.List;

import org.apache.ibatis.annotations.Mapper;

import com.shop.cafe.dto.Cart;
import com.shop.cafe.dto.Product;

@Mapper
public interface CartDao {
	public void addCart(Cart c);
}
```

### ì„œë¹„ìŠ¤ ê³„ì¸µ (Service) : CartService.java
ğŸ”¹ DAOë¥¼ í˜¸ì¶œí•˜ì—¬ íšŒì› ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì—­í• 

```java
package com.shop.cafe.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.shop.cafe.dao.CartDao;
import com.shop.cafe.dto.Cart;
import com.shop.cafe.dto.Product;


@Service
public class CartService {
	@Autowired
	CartDao cartDao;

	public void addCart(Cart c) throws Exception{
		cartDao.addCart(c);
	}
}
```

### ì»¨íŠ¸ë¡¤ëŸ¬ (Controller) : CartController.java
ğŸ”¹ REST API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•˜ì—¬ íšŒì›ê°€ì… ìš”ì²­ì„ ì²˜ë¦¬

```java
package com.shop.cafe.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RestController;

import com.shop.cafe.dto.Cart;
import com.shop.cafe.service.CartService;

@RestController
@CrossOrigin("http://127.0.0.1:5500/")
public class CartController {
	@Autowired
	CartService cartService;
	
	@PostMapping("addCart")
	public void addCart(@RequestBody Cart c, @RequestHeader String authorization) {
		try {
			if(authorization.equals(c.getToken())) {
				cartService.addCart(c);
			} else {
				System.out.println("ë‹¤ë¦„");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
}
```

## í”„ë¡ íŠ¸ì—”ë“œ (FRONT)
### Cart.js
```js
let prodcode;

document.addEventListener("click", async (event) => {
  if (event.target.classList.contains("cart-btn")) {
    prodcode = event.target.dataset.productId;
    try {
      const reviewsResponse = await axios.post(
        "http://localhost:8080/addCart",
        { prodcode: prodcode, token: sessionStorage.Authorization }
      );
      const cart = reviewsResponse.data;
    } catch (error) {
      console.error("ì—ëŸ¬");
    }
  }
});
```

<img src="/assets/post/2025/ureca/day31_class_1.png" alt='' width=1300px>

---
