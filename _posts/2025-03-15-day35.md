---
title: "[Day35] ì‡¼í•‘ëª° ì‹¤ìŠµ - Kakao OAuth"
categories: [Ureca, Spirng]
tags: [Spirng, Kakao OAuth]
image:
  path: /assets/post/2025/ureca/day35_class_2.png
  alt: spring
published: true
---

# Kakao OAuthë¥¼ í†µí•œ ë¡œê·¸ì¸
## ì‹œí€€ìŠ¤
<img src="/assets/post/2025/ureca/day35_class_1.png" alt='' width=1300px>

## ì¤€ë¹„
ì¹´ì¹´ì˜¤ ê°œë°œì ì„¼í„°(https://developers.kakao.com/)ë¡œ ê°€ì„œ ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ í™œì„±í™” í•˜ê³  REST API í‚¤ ê°€ì ¸ ì˜¤ê¸°

```
ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ê¸°ëŠ¥ í™œì„±í™” ë°©ë²•
1) ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ì œí’ˆ ì„¤ì • > ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    : í™œì„±í™” ì„¤ì • => ON
      Redirect URI => http://back_ip:8080/kakaoLoginCallback
      ë™ì˜ í•­ëª© => account_email (ê°œì¸ ê°œë°œì ë¹„ì¦ˆ ì•± ì „í™˜ì´ ë˜ì–´ì•¼ ë™ì˜í•­ëª©ìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŒ)
      
   
2) ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ì•± ì„¤ì • > ì•±í‚¤
    : REST API í‚¤ => ë³µì‚¬
```

## BACK (ë°±ì—”ë“œ)
### ğŸ“Œ ë³´ì•ˆ ì„¤ì • : secu.properties

API Key ë“± ì¤‘ìš”í•œ ì •ë³´ë¥¼ secu.propertiesì— ì €ì¥í•˜ì—¬ ê´€ë¦¬

```
DB_DRIVER=com.mysql.cj.jdbc.Driver
DB_URL=jdbc:mysql://localhost:3306/ureca
DB_USER=ureca
DB_PW=ureca

KAKAO_API_KEY=b343b2cbddccf...
```

### ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ì½ê¸° : application.properties

application.propertiesì—ì„œ secu.propertiesì˜ KEYë¥¼ ì½ì–´ ì˜¤ë„ë¡ ì„¤ì •í•œë‹¤

```
spring.application.name=CoffeShop

spring.datasource.driver-class-name=${DB_DRIVER}
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PW}

logging.level.com.shop.cafe=debug

mybatis.type-aliases-package=com.shop.cafe.dto
mybatis.mapper-locations=mapper/*.xml

kakao.api.key=${KAKAO_API_KEY}
```

### ğŸ“Œ ì‚¬ìš©ìë¥¼ Kakao ì¸ì¦ í™”ë©´ìœ¼ë¡œ ë¦¬ë””ë ‰íŠ¸ : OAuthController.java
Kakao ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ, kakao OAuth ì¸ì¦ í™”ë©´ìœ¼ë¡œ redirect -> ì‚¬ìš©ì ë™ì˜ ì½”ë“œ ë°›ê¸°

```java
@Controller
public class OAuthController {

	@Value("${kakao.api.key}")
	String KAKAO_API_KEY ;

  //  Kakao ì¸ì¦ í™”ë©´ìœ¼ë¡œ ë¦¬ë””ë ‰íŠ¸
	@GetMapping("kakaoLogin")
	public String kakaoLogin() {
		return "redirect:https://kauth.kakao.com/oauth/authorize?client_id=" 
		+ KAKAO_API_KEY 
				+ "&redirect_uri=http://localhost:8080/kakaoLoginCallback&response_type=code";
	}
	
  // ì‚¬ìš©ì ë™ì˜ í›„ Kakaoì—ì„œ codeë¥¼ ë°˜í™˜ & AccessToken ì¶œë ¥
	@GetMapping("kakaoLoginCallback")
	public String kakaoCallback(@RequestParam String code){
    String access_Token = oAuthService.getKaKaoAccessToken(code);
    System.out.println("access_Token :" + access_Token );
    System.out.println("ì‚¬ìš©ì ë™ì˜ ì½”ë“œ:" + code);
		return null;
	}
}
```

### ğŸ“Œ ë™ì˜ ì½”ë“œë¡œ Access Token ìš”ì²­ : OAuthService.java
kakaoì—ê²Œ ë™ì˜ì½”ë“œ ë‚´ë°€ë©° AccessToken ìš”ì²­í•˜ê¸°

```java
@Service
public class OAuthService {
	@Value("${kakao.api.key}")
	String KAKAO_API_KEY ;
	
	public String getKaKaoAccessToken(String code) {
	    String access_Token = "";
	    String refresh_Token = "";
	    String reqURL = "https://kauth.kakao.com/oauth/token";

	    try {
        URL url = new URL(reqURL);
        HttpURLConnection conn = (HttpURLConnection) url.openConnection();

        // POST ìš”ì²­ì„ ìœ„í•´ ê¸°ë³¸ê°’ì´ falseì¸ setDoOutputì„ trueë¡œ
        conn.setRequestMethod("POST");
        conn.setDoOutput(true);

        // POST ìš”ì²­ì— í•„ìš”ë¡œ ìš”êµ¬í•˜ëŠ” íŒŒë¼ë¯¸í„° ìŠ¤íŠ¸ë¦¼ì„ í†µí•´ ì „ì†¡
        BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(conn.getOutputStream()));
        StringBuilder sb = new StringBuilder();
        sb.append("grant_type=authorization_code");
        sb.append("&client_id=" + KAKAO_API_KEY );
        sb.append("&redirect_uri=http://localhost:8080/kakaoLoginCallback");
        sb.append("&code=" + code);
        bw.write(sb.toString());
        bw.flush();

        // ê²°ê³¼ ì½”ë“œê°€ 200ì´ë¼ë©´ ì„±ê³µ
        int responseCode = conn.getResponseCode();
        System.out.println("responseCode : " + responseCode);
        
        // ìš”ì²­ì„ í†µí•´ ì–»ì€ JSONíƒ€ì…ì˜ Response ë©”ì„¸ì§€ ì½ì–´ì˜¤ê¸°
        BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
        String line = "";
        String result = "";

        while ((line = br.readLine()) != null) {
            result += line;
        }
        System.out.println("response body : " + result);

        // Jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ JSON íŒŒì‹±
        ObjectMapper objectMapper = new ObjectMapper();
        JsonNode jsonNode = objectMapper.readTree(result);

        access_Token = jsonNode.get("access_token").asText();
        refresh_Token = jsonNode.get("refresh_token").asText();

        System.out.println("access_token : " + access_Token);
        System.out.println("refresh_token : " + refresh_Token);

        br.close();
        bw.close();
	    } catch (IOException e) {
        e.printStackTrace();
	    }
	    return access_Token;
	}	
}
```

### ğŸ“Œ kakaoì—ê²Œ AccessToken ë‚´ë°€ë©° ì‚¬ìš©ì ì •ë³´ ìš”ì²­ : OAuthService.java
Access Tokenì„ ì‚¬ìš©í•˜ì—¬ Kakaoì—ì„œ ì‚¬ìš©ì ì´ë©”ì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜´.

```java
public String getKakaoUser(String token) {
    String reqURL = "https://kapi.kakao.com/v2/user/me";
    String email = "";

    try {
        URL url = new URL(reqURL);
        HttpURLConnection conn = (HttpURLConnection) url.openConnection();
        conn.setRequestMethod("POST");
        conn.setRequestProperty("Authorization", "Bearer " + token);

        BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
        String result = br.readLine();

        ObjectMapper objectMapper = new ObjectMapper();
        JsonNode jsonNode = objectMapper.readTree(result);
        
        boolean hasEmail = jsonNode.get("kakao_account").get("has_email").asBoolean();
        if (hasEmail) {
            email = jsonNode.get("kakao_account").get("email").asText();
        }
        System.out.println("email : " + email);
        br.close();
    } catch (IOException e) {
        e.printStackTrace();
    }
    return email;
}
```

### ğŸ“Œ Access Tokenê³¼ ì´ë©”ì¼ ì¶œë ¥ : OAuthController.java

```java
@GetMapping("kakaoLoginCallback")
public String kakaoCallback(@RequestParam String code) {
    System.out.println("ì‚¬ìš©ì ë™ì˜ ì½”ë“œ:" + code);

    String access_Token = oAuthService.getKaKaoAccessToken(code);
    System.out.println("access_Token :" + access_Token);
    
    String email = oAuthService.getKakaoUser(access_Token);
    System.out.println("email  :" + email);
    
    return null;
}
```

### ğŸ“Œ Access Tokenê³¼ Emailì„ ì¿ í‚¤ì— ì €ì¥ : OAuthController.java
`OAuthController.java`ì—ì„œ emailê³¼ AccessTokenì„ ì¿ í‚¤ë¡œ ì„¤ì •í•´ì„œ kakao ì„œë²„ë¡œ ë¦¬í„´í•˜ë©´ kakaoì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ redirect pageë¥¼ ë³´ë‚´ì¤€ë‹¤. ì´ë•Œ í´ë¼ì´ì–¸íŠ¸ ë¸Œë¼ìš°ì €ì— ì¿ í‚¤ê°€ ì €ì¥ëœë‹¤

```java
@GetMapping("kakaoLoginCallback")
public String kakaoCallback(@RequestParam String code, HttpServletResponse response) {
    String access_Token = oAuthService.getKaKaoAccessToken(code);
    String email = oAuthService.getKakaoUser(access_Token);

    if (email != null) {
        Cookie c1 = new Cookie("email", email);
        Cookie c2 = new Cookie("Authorization", access_Token);

        response.addCookie(c1);
        response.addCookie(c2);
    }
    return "redirect:http://localhost:5500/";
}
```

### ğŸ“Œ ë¡œê·¸ì¸ ì •ë³´ë¥¼ DBì— ì €ì¥ : OAuthService.java

- ë¡œê·¸ì¸ ì •ë³´ë¥¼ DBì— ì €ì¥í•˜ê¸° ìœ„í•´ insertLoginInfo()ë¼ëŠ” ë©”ì†Œë“œë¥¼ ì¶”ê°€

```java
@Autowired
LoginDao loginDao;

public void insertLoginInfo(String email, String kakaoToken) throws Exception {
    Login loginInfo = new Login(email, kakaoToken, null, new Date());
    loginDao.insertToken(loginInfo);
}
```

### ë°±ì—”ë“œ íë¦„
âœ… secu.propertiesë¡œ API Key ë³´ì•ˆ ê´€ë¦¬      
âœ… application.propertiesì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ      
âœ… Kakao ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ë¦¬ë””ë ‰íŠ¸           
âœ… ë™ì˜ ì½”ë“œ(code)ë¥¼ ë°›ì•„ Access Token ìš”ì²­          
âœ… Access Tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´(ì´ë©”ì¼) ìš”ì²­                
âœ… ì´ë©”ì¼ê³¼ Access Tokenì„ ì¿ í‚¤ì— ì €ì¥ ë° DBì— ì €ì¥

-----

## FRONT (í”„ë¡ íŠ¸ì—”ë“œ)
### index.html : ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
`http://localhost:8080/kakaoLogin`ìœ¼ë¡œ ì´ë™í•˜ì—¬ OAuth ì¸ì¦ ìš”ì²­

```js
<a href="http://localhost:8080/kakaoLogin">
    <img src="img/kakao.png" width="50">
</a>
```

### ğŸ“Œ ë¡œê·¸ì¸ ìš”ì²­ í›„ ì²˜ë¦¬ : member.js

- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ í›„ ë°›ì€ Authorization í† í°ì„ ì €ì¥      
- ì„¸ì…˜ ë˜ëŠ” ì¿ í‚¤ì—ì„œ Authorizationì´ ìˆìœ¼ë©´ ìë™ ë¡œê·¸ì¸ ìœ ì§€

```js
let Authorization = sessionStorage.getItem("Authorization");
const nickname = sessionStorage.getItem("nickname");

if (Authorization && nickname) {
  axios.defaults.headers.common["Authorization"] = Authorization; 
  document.getElementById("loginSpan").innerHTML = `${nickname}  
  <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>`;
} else {
  Authorization = getCookie("Authorization");
  email = getCookie("email");
  if (Authorization && email) {
    axios.defaults.headers.common["Authorization"] = Authorization; 
    document.getElementById("loginSpan").innerHTML = `${email}  
    <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>`;
  }
}
```

### ğŸ“Œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬

- ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒ ì‹œ ì„¸ì…˜ê³¼ ì¿ í‚¤ ì´ˆê¸°í™” í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨

```js
document.getElementById("loginSpan").addEventListener("click", async (event) => {
  if (event.target.id == "logoutBtn") {
    await axios.post("http://localhost:8080/logout");
    sessionStorage.removeItem("nickname");
    sessionStorage.removeItem("Authorization");
    axios.defaults.headers.common["Authorization"] = ""; 

    removeCookie("Authorization");
    removeCookie("email");

    window.location.reload();
  }
});
```

### ğŸ“Œ ì¿ í‚¤ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

- ì¿ í‚¤ì—ì„œ Authorization ê°€ì ¸ì˜¤ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥

```js
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(";");
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == " ") {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function removeCookie(cname) {
  document.cookie = cname + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
}
```

### í”„ë¡ íŠ¸ì—”ë“œ íë¦„
1ï¸âƒ£ ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
2ï¸âƒ£ ë°±ì—”ë“œ(http://localhost:8080/kakaoLogin)ë¡œ ì´ë™ â†’ OAuth ì¸ì¦ ìš”ì²­
3ï¸âƒ£ ì¹´ì¹´ì˜¤ì—ì„œ ì¸ì¦ í›„, ë°±ì—”ë“œì—ì„œ Authorization í† í° ë°œê¸‰
4ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸ê°€ sessionStorage ë˜ëŠ” ì¿ í‚¤ì— í† í° ì €ì¥
5ï¸âƒ£ ì´í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ìë™ ë¡œê·¸ì¸ ìœ ì§€
6ï¸âƒ£ ë¡œê·¸ì•„ì›ƒí•˜ë©´ ì„¸ì…˜ê³¼ ì¿ í‚¤ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨

---

## í”„ë¡œì íŠ¸ì— ì ìš©í•œ ì „ì²´ ì½”ë“œ ì°¸ê³ 
[Kakao OAuth](https://github.com/y-car-project/y-car-back/commit/1ec5f57ef7c55071602d20bcb78745df9df63ffc)

---

## END